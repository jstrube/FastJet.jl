using BinaryProvider
using CxxWrap # this is needed for opening the dependency lib. Otherwise Libdl.dlopen fails

##################### Fastjet ###########################s
const fjversion = "v3.3.2"
const verbose = "--verbose" in ARGS || true
const FASTJET_DIR = get(ENV, "FASTJET_DIR", "")
const prefix = Prefix(FASTJET_DIR == "" ? get([a for a in ARGS if a != "--verbose"], 1, joinpath(@__DIR__, "usr")) : FASTJET_DIR)
products = [
    LibraryProduct(prefix, ["libfastjetwrap"], :libfastjetwrap),
]

# Download binaries from hosted location
bin_prefix = "https://github.com/jstrube/FastJetWrapBuilder/releases/download/v0.4"

# Listing of files generated by BinaryBuilder:
download_info = Dict(
    MacOS(:x86_64, compiler_abi=CompilerABI(:gcc7)) => ("$bin_prefix/FastJetWrapBuilder.v0.4.0.x86_64-apple-darwin14-gcc7.tar.gz", "6d9f9b6e11cd308db197b3fd4cd8761f312b856a0b4a657dec1db8299bfe764b"),
    MacOS(:x86_64, compiler_abi=CompilerABI(:gcc8)) => ("$bin_prefix/FastJetWrapBuilder.v0.4.0.x86_64-apple-darwin14-gcc8.tar.gz", "763b5e5fd0bb06117c46af3e673312dfe415536c01c5b89b2956feaf67e7b42a"),
    Linux(:x86_64, libc=:glibc, compiler_abi=CompilerABI(:gcc7, :cxx11)) => ("$bin_prefix/FastJetWrapBuilder.v0.4.0.x86_64-linux-gnu-gcc7-cxx11.tar.gz", "93c5101f3cddea65d57bd38d919c830601d7ea0d7c16e675ccc8feb69d91fc00"),
    Linux(:x86_64, libc=:glibc, compiler_abi=CompilerABI(:gcc8, :cxx11)) => ("$bin_prefix/FastJetWrapBuilder.v0.4.0.x86_64-linux-gnu-gcc8-cxx11.tar.gz", "7564fe12b520b2aa795ac45949b871420e51f82b7eacfb8a10c496b844be8474"),
)

transform_platform(platform) = typeof(platform)(platform.arch;libc=platform.libc,call_abi=platform.call_abi,compiler_abi=CompilerABI(max(platform.compiler_abi.gcc_version,:gcc7),:cxx11))
transform_platform(platform::MacOS) = MacOS(:x86_64)

# Install unsatisfied or updated dependencies:
unsatisfied = any(!satisfied(p; verbose=verbose) for p in products)
if FASTJET_DIR == ""
    platform = transform_platform(platform_key_abi())
    if haskey(download_info, platform)
        url, tarball_hash = download_info[platform]
        if unsatisfied || !isinstalled(url, tarball_hash; prefix=prefix)
            # Download and install binaries
            install(url, tarball_hash; prefix=prefix, force=true, verbose=verbose,ignore_platform=true)
        end
    elseif unsatisfied
        # If we don't have a BinaryProvider-compatible .tar.gz to download, complain.
        # Alternatively, you could attempt to install from a separate provider,
        # build from source or something even more ambitious here.
        error("Your platform $(triplet(platform)) is not supported by this package!")
    end
else
    if unsatisfied
        error("The required libraries were not found in the provided LCIO_DIR directory $LCIO_DIR")
    end
end


# Write out a deps.jl file that will contain mappings for our products
write_deps_file(joinpath(@__DIR__, "deps.jl"), products, verbose=verbose)
